<div id="calendar-app">
  <p class="mb-1">Logged in as <strong><%= current_user&.name || 'Guest' %></strong></p>
  <% unless current_user %>
    <a href="/register" class="btn btn-sm btn-outline-primary mb-2">Register</a>
  <% end %>
  <div class="nav d-flex flex-wrap align-items-center gap-1">
    <a class="btn btn-outline-primary btn-sm" :href="'/calendar?week=' + prevWeek">&laquo; Previous 4 weeks</a>
    <a class="btn btn-outline-primary btn-sm" :href="'/calendar?week=' + nextWeek">Next 4 weeks &raquo;</a>
    <select v-model.number="extra" class="form-select form-select-sm" style="width:auto;">
      <option :value="0">+0</option>
      <option v-for="n in 10" :value="n">+{{ n }}</option>
    </select>
    <button class="btn btn-success btn-sm" @click="ruleMode=!ruleMode" v-text="ruleMode ? 'Cancel' : 'Add Rule'"></button>
  </div>
  <h2 class="h5 text-center mb-2">{{ monthLabel }}</h2>
  <div id="rule-bar" class="rule-bar input-group input-group-sm" :style="ruleBarStyle()">
    <input type="text" class="form-control" v-model="ruleText" placeholder="Rule text">
    <button class="btn btn-primary" @click="applyRule"><i class="bi bi-check"></i></button>
    <span class="input-group-text" v-if="selectedForRule.length">Avg: {{ selectedAvg }}</span>
  </div>
  <div v-if="dayView === null">
    <div v-for="month in months" class="mb-2">
      <h3 class="h6 text-center">{{ month.label }}</h3>
      <table class="table table-bordered days">
        <tbody>
          <tr v-for="week in month.weeks">
            <td v-for="day in week" class="day" @click="openDay(day.index)" :style="dayStyle(maxPerDay[day.index])" :class="{'has-rule': maxPerDay[day.index].note}">
              <div class="day-info">{{ formatDay(day.date) }}</div>
              <div class="day-count">{{ maxPerDay[day.index].max }}</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div v-else>
    <button class="btn btn-sm btn-outline-secondary mb-2" @click="closeDay">&laquo; Back</button>
    <table class="table table-bordered calendar">
      <thead>
        <tr>
          <th class="time-col">Time</th>
          <th>{{ formatDay(days[dayView]) }}</th>
          <th class="info-col"></th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="t in times">
          <th class="time-col">{{ formatTime(t) }}</th>
          <td class="slot" :data-slot-id="findSlotByIndex(dayView,t)?.id" :class="slotClasses(findSlotByIndex(dayView,t))" :style="cellStyle(findSlotByIndex(dayView,t))" @click="onSlotClick(findSlotByIndex(dayView,t), $event)">
            <div class="count" v-if="findSlotByIndex(dayView,t)">{{ findSlotByIndex(dayView,t).count }}</div>
            <div class="note" v-if="findSlotByIndex(dayView,t) && findSlotByIndex(dayView,t).note">
              {{ findSlotByIndex(dayView,t).note }}
              <span class="avg">{{ ruleAverages[findSlotByIndex(dayView,t).note] }}</span>
            </div>
          </td>
          <td class="info-col">
            <button v-if="findSlotByIndex(dayView,t)" type="button" class="btn btn-link p-0" @click.stop="showInfo(findSlotByIndex(dayView,t))"><i class="bi bi-people"></i></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>
<div class="modal fade" id="infoModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Participants</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-unstyled mb-0">
          <li v-for="u in infoUsers" :key="u">{{ u }}</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<script>
var WEEK = '<%= @start_week %>';
var PREV_WEEK = '<%= @prev_week %>';
var NEXT_WEEK = '<%= @next_week %>';
</script>
<script src="/js/calendar.js"></script>
