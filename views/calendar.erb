<div id="calendar-app">
  <p class="mb-1">Logged in as <strong><%= current_user&.name || 'Guest' %></strong></p>
  <% unless current_user %>
    <a href="/register" class="btn btn-sm btn-outline-primary mb-2">Register</a>
  <% end %>
  <div class="nav d-flex flex-wrap align-items-center gap-1">
    <a class="btn btn-outline-primary btn-sm" :href="'/calendar?week=' + prevWeek">&laquo; Previous</a>
    <a class="btn btn-outline-primary btn-sm" :href="'/calendar?week=' + nextWeek">Next &raquo;</a>
    <select v-model.number="extra" class="form-select form-select-sm" style="width:auto;">
      <option :value="0">+0</option>
      <option v-for="n in 10" :value="n">+{{ n }}</option>
    </select>
    <button class="btn btn-success btn-sm" @click="ruleMode=!ruleMode" v-text="ruleMode ? 'Cancel' : 'Add Rule'"></button>
  </div>
  <h2 class="h5 text-center mb-2">{{ monthLabel }}</h2>
  <div id="rule-bar" class="rule-bar input-group input-group-sm" :style="ruleBarStyle()">
    <input type="text" class="form-control" v-model="ruleText" placeholder="Rule text">
    <button class="btn btn-primary" @click="applyRule"><i class="bi bi-check"></i></button>
    <span class="input-group-text" v-if="selectedForRule.length">Avg: {{ selectedAvg }}</span>
  </div>
  <div v-if="dayView === null">
    <table class="table table-bordered days">
      <tbody>
        <tr>
          <td v-for="(d,i) in days" class="day" @click="openDay(i)" :style="dayStyle(maxPerDay[i])" :class="{'has-rule': maxPerDay[i].note}">
            <div class="position-relative">
              <span class="day-label">{{ formatDay(d) }}</span>
              <span class="count">{{ maxPerDay[i].max }}</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div v-else>
    <button class="btn btn-sm btn-outline-secondary mb-2" @click="closeDay">&laquo; Back</button>
    <table class="table table-bordered calendar">
      <thead>
        <tr>
          <th>Time</th>
          <th>{{ formatDay(days[dayView]) }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="t in times">
          <th>{{ formatTime(t) }}</th>
          <td class="slot" :data-slot-id="findSlotByIndex(dayView,t)?.id" :class="slotClasses(findSlotByIndex(dayView,t))" :style="cellStyle(findSlotByIndex(dayView,t))" @click="onSlotClick(findSlotByIndex(dayView,t), $event)" :data-bs-toggle="slotTitle(findSlotByIndex(dayView,t)) ? 'tooltip' : null" :title="slotTitle(findSlotByIndex(dayView,t))">
            <span v-if="findSlotByIndex(dayView,t)" class="count">{{ findSlotByIndex(dayView,t).count }}</span>
            <span v-if="findSlotByIndex(dayView,t) && findSlotByIndex(dayView,t).note" class="note">{{ findSlotByIndex(dayView,t).note }}</span>
            <span v-if="findSlotByIndex(dayView,t) && findSlotByIndex(dayView,t).note" class="avg">{{ ruleAverages[findSlotByIndex(dayView,t).note] }}</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>
<script>
var WEEK = '<%= @start_week %>';
var PREV_WEEK = '<%= @prev_week %>';
var NEXT_WEEK = '<%= @next_week %>';
</script>
<script src="/js/calendar.js"></script>
